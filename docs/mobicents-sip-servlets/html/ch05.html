<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory">Chapter 5. Clustering and High Availability</title><link rel="stylesheet" href="css/jbossorg.css" type="text/css"/><meta xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" name="generator" content="DocBook XSL Stylesheets V1.74.0"/><link rel="home" href="index.html" title="SIP Servlets Server User Guide"/><link rel="up" href="index.html" title="SIP Servlets Server User Guide"/><link rel="prev" href="ssea-SIP_Servlet_Example_Applications.html" title="Chapter 4. SIP Servlet Example Applications"/><link rel="next" href="emom-Enterprise-Monitoring-Operations-Management.html" title="Chapter 6. Enterprise Monitoring and Management"/></head><body><p id="title"><a href="http://www.jboss.org" class="site_href"><strong>JBoss.org</strong></a><a href="http://docs.jboss.org/" class="doc_href"><strong>Community Documentation</strong></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="ssea-SIP_Servlet_Example_Applications.html"><strong>Prev</strong></a></li><li class="next"><a accesskey="n" href="emom-Enterprise-Monitoring-Operations-Management.html"><strong>Next</strong></a></li></ul><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e5521"/>Chapter 5. Clustering and High Availability</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="ch05.html#ssfjcs-SS_for_JBoss-Clustering_Support">5.1. Mobicents SIP Servlets for JBoss: Clustering Support</a></span></dt><dd><dl><dt><span class="section"><a href="ch05.html#ssfjcs-binary-SIP_Servlets_Server_Cluster-Installing_Configuring_and_Running">5.1.1. SIP Servlets Server Cluster: Installing, Configuring and Running</a></span></dt></dl></dd><dt><span class="section"><a href="ch05.html#ssfjfs-SS_for_JBoss-Failover_Support">5.2. Mobicents SIP Servlets for JBoss: Transparent Failover</a></span></dt><dd><dl><dt><span class="section"><a href="ch05.html#ssfjfs-binary-Testing_SS_for_JBoss_Cluster_Failover--Installing_Configuring_and_Running">5.2.1. MSS for JBoss Cluster: Installing, Configuring and Running</a></span></dt></dl></dd><dt><span class="section"><a href="ch05.html#sslb-MSS_Load_Balancer">5.3. Load Balancer</a></span></dt><dd><dl><dt><span class="section"><a href="ch05.html#sslb-SIP_Load_Balancing_Basics">5.3.1. SIP Load Balancing Basics</a></span></dt><dt><span class="section"><a href="ch05.html#d0e5812">5.3.2. HTTP Load Balancing Basics</a></span></dt><dt><span class="section"><a href="ch05.html#d0e5851">5.3.3. Pluggable balancer algorithms</a></span></dt><dt><span class="section"><a href="ch05.html#d0e5888">5.3.4. Distributed load balancing</a></span></dt><dt><span class="section"><a href="ch05.html#sslb-SIP_Servlets_Load_Balancer-Implementation">5.3.5. Implementation of the Mobicents Load Balancer</a></span></dt><dt><span class="section"><a href="ch05.html#d0e5918">5.3.6. SIP Message Flow</a></span></dt><dt><span class="section"><a href="ch05.html#sslb-binary-SIP_Load_Balancer-Installing_Configuring_and_Running">5.3.7. SIP Load Balancer: Installing, Configuring and Running</a></span></dt><dt><span class="section"><a href="ch05.html#d0e6508">5.3.8. IP Load Balancing</a></span></dt></dl></dd></dl></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="ssfjcs-SS_for_JBoss-Clustering_Support"/>5.1. Mobicents SIP Servlets for JBoss: Clustering Support</h2></div></div></div><p>Mobicents supports the clustering of SIP Servlets-enabled JBoss Application Servers for performance, reliability and failover purposes. Note that only MSS for JBoss Servers can be used as cluster nodes; MSS for Tomcat Containers are not supported.</p><p>The SIP Servlets Server uses the  JBoss Application Server as its servlet container, and takes advantage of its capabilities, including clustering and failover.  For detailed background information about JBoss Application Server clustering refer to the <a class="ulink" href="http://www.jboss.org/file-access/default/members/jbossas/freezone/docs/Clustering_Guide/beta422/html/index.html">JBoss Application Server Clustering Guide</a>.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="ssfjcs-binary-SIP_Servlets_Server_Cluster-Installing_Configuring_and_Running"/>5.1.1. SIP Servlets Server Cluster: Installing, Configuring and Running</h3></div></div></div><p/><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="ssfjcs-binary-SIP_Servlets_Server_Cluster-PreInstall_Requirements_and_Prerequisites"/>5.1.1.1. Pre-Install Requirements and Prerequisites</h4></div></div></div><p/><div class="variablelist"><a id="ssfjcs-binary-SIP_Servlets_Server_Cluster-Software_Prerequisites"/><p class="title"><b>Software Prerequisites</b></p><dl><dt><span class="term">A SIP Servlets-enabled JBoss Application Server</span></dt><dd><p>Before proceeding, ensure you have correctly configured your JBoss Application Server, according to SIP Servlet Server requirements:</p><div class="itemizedlist"><ul><li><p>
         <a class="xref" href="sssicar-SIP_Servlets_Server-Installing_Configuring_and_Running.html#bssswjicar-binary-SIP_Servlets_Server_with_JBoss-Installing_Configuring_and_Running" title="2.1. SIP Servlet-Enabled JBoss Application Server: Installing, Configuring and Running">Section 2.1, “SIP Servlet-Enabled JBoss Application Server: Installing, Configuring and Running”</a>
        </p></li></ul></div><p>The easiest way to set up a cluster of SIP Servlets-enabled JBoss Application Servers is to install, configure and test the binary distribution on one machine, and then  copy the entire installation (directory) to the other machines in the cluster. This is the approach taken in this chapter.</p><p>Install a SIP Servlets Server with JBoss by following the instructions detailed in <a class="xref" href="sssicar-SIP_Servlets_Server-Installing_Configuring_and_Running.html#bssswjicar-binary-SIP_Servlets_Server_with_JBoss-Installing_Configuring_and_Running" title="2.1. SIP Servlet-Enabled JBoss Application Server: Installing, Configuring and Running">Section 2.1, “SIP Servlet-Enabled JBoss Application Server: Installing, Configuring and Running”</a>. </p><p>Afer meeting the requirement you can begin to configure the server  <a class="xref" href="ch05.html#ssfjcs-binary-SIP_Servlets_Server_Cluster-Configuring" title="5.1.1.2. Configuring">Section 5.1.1.2, “Configuring”</a> below.</p></dd></dl></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="ssfjcs-binary-SIP_Servlets_Server_Cluster-Configuring"/>5.1.1.2. Configuring</h4></div></div></div><p>Once installed, the MSS for JBoss binary distribution requires only minor configuration in order to enable clustering. </p><p>SIP, and HTTP session state clustering is  pre-configured straight out of the binary distribution. However, to enable session replication in a node, you must tag it as <code class="literal">&lt;distributable/&gt;</code> both in the <code class="filename">web.xml</code> and <code class="filename">sip.xml</code> descriptors. This can be done only individually (per application).</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="ssfjcs-binary-SIP_Servlets_Server_Cluster-Running"/>5.1.1.3. Running</h4></div></div></div><p>Clustering with MSS for JBoss nodes requires running all of the nodes using the "all" Server Configuration Profile, which is specified when you invoke <code class="command">run.sh</code> or <code class="command">run.bat</code>.</p><h5 xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="formalpara">Running MSS for JBoss with the "all" Configuration Profile, on Linux</h5><p class="formalpara">To run the server on Linux using the "all" Configuration Profile, start the server with the following command:</p><pre class="screen">MSS-jboss-&lt;version&gt;]$ ./bin/run.sh -c all</pre><h5 xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="formalpara">Running MSS for JBoss with the "all" Configuration Profile, on Windows</h5><p class="formalpara">To run the server on Windows using the "all" Configuration Profile, open the Command Prompt, change your folder to the topmost folder of your MSS for JBoss installation, and issue the following command:</p><pre class="screen">C:Usersuser\&lt;username&gt;My DownloadsMSS-jboss-&lt;version&gt;&gt;binrun.bat -c all</pre><h5 xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="formalpara">Distributing requests between nodes</h5><p class="formalpara">Together with the application server nodes, it is advised to run a SIP load-balancer or an IP load-balancer.  The IP load balancer will distribute the traffic evenly between the nodes. A load-balancer is a single entry-point to all nodes. All calls should be made through the load balancer if  High Availability is required. For more information about load balancing, refer to  <a class="xref" href="ch05.html#sslb-SIP_Servlets_Load_Balancer-Implementation" title="5.3.5. Implementation of the Mobicents Load Balancer">Section 5.3.5, “Implementation of the Mobicents Load Balancer”</a>.</p><p>By default, the servers are configured with one SIP load-balancer set to the  IP address <code class="literal">127.0.0.1</code>. This is specified in the <code class="literal">balancers</code> attribute in the <code class="filename">server.xml</code> configuration file as follows:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">Service</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;jboss.web&quot;</span><span class="xml_plain">&nbsp;</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">className</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;org.mobicents.servlet.sip.startup.failover.SipStandardBalancerNodeService&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_attribute_name">balancers</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;127.0.0.1&quot;</span><span class="xml_plain">&nbsp;&nbsp;</span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_attribute_name">sipPathName</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;org.mobicents.ha&quot;</span><span class="xml_plain">&nbsp;&nbsp;</span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_attribute_name">sipApplicationDispatcherClassName</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;org.mobicents.servlet.sip.core.SipApplicationDispatcherImpl&quot;</span><span class="xml_plain"></span><br />
<span class="xml_attribute_name">concurrencyControlMode</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;None&quot;</span><span class="xml_plain">&nbsp;</span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_attribute_name">darConfigurationFileLocation</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;conf/dars/mobicents-dar.properties&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_attribute_name">sipStackPropertiesFile</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;conf/mss-sip-stack.properties&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>Multiple load balancers can be specified and all of them will be updated on the health status of the node. The complete syntax for the balancers string is the following:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">Service</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;jboss.web&quot;</span><span class="xml_plain">&nbsp;</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_attribute_name">balancers</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;ipAddress1:sipPort1:rmiPort1;ipAddress2:sipPort2:rmiPort2;..3...4..&quot;</span><span class="xml_plain">&nbsp;&nbsp;</span><br />
<span class="xml_plain">&nbsp;&nbsp;...</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>If the RMI port is omitted port 2000 is assumed, and if the SIP port is omitted 5065 is assumed.</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2><p>The SIP port  specified in the balancers string for each balancer refers to the internal SIP port of the SIP balancer. That is because the internal port faces the cluster nodes directly. Requests coming through the internal port will go to the external port and vice versa. If you put the external port in the <code class="literal">balancers</code> string, then the SIP LB will assume that the requests comes from outside the cluster and it will route it back to some cluster node instead of routing it outside the cluster as expected. Always use the SIP internal port in the <code class="literal">balancers</code> string. Exception to this rule is when a single port is used for internal and external ports in the SIP load balancer. In that case the direction analysis is done based on <code class="literal">Via</code> headers and the requests are routed correctly without extra settings.</p><p/></div><p>When multiple SIP load balancers are specified, the outgoing requests will always go through the first one, or an IP load balancer can be used and the requests will be distributed based on the IP balancer policy. To route the outgoing requests to a particular IP address (the IP load balancer address for example) the <code class="literal">outboundProxy</code> property can be used:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">Service</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;jboss.web&quot;</span><span class="xml_plain">&nbsp;</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_attribute_name">balancers</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;127.0.0.1:5060:2000;127.0.0.1:5160:2100&quot;</span><span class="xml_plain">&nbsp;&nbsp;</span><br />
<span class="xml_attribute_name">outboundProxy</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;127.0.0.1:5500&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;...</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>In this example configuration all outbound requests will go through 127.0.0.1:5500, while the node will perform the health checks against two SIP load balancers. If the 127.0.0.1:5500 machine is an IP load balancer it should be configured to spray the  SIP load balancers and they will route the requests outside the cluster reliably.</p><p>The <code class="literal">outboundProxy</code> attribute overrides the default effect of specifying a SIP port for SIP load balancers in the <code class="literal">balancers</code> string.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="ssfjcs-binary-SIP_Servlets_Server_Cluster-Stopping"/>5.1.1.4. Stopping</h4></div></div></div><p>Individual nodes in the cluster should be stopped one-by-one, followed by the SIP load balancer. Refer to:</p><div class="itemizedlist"><ul><li><p>Stopping the SIP load balancer: <a class="xref" href="ch05.html#sslb-binary-SIP_Load_Balancer-Stopping" title="5.3.7.7. Stopping">Section 5.3.7.7, “Stopping”</a>
     </p></li><li><p>Stopping MSS for JBoss: <a class="xref" href="sssicar-SIP_Servlets_Server-Installing_Configuring_and_Running.html#bssswjicar-binary-SIP_Servlets_Server_with_JBoss-Stopping" title="2.1.10. Stopping">Section 2.1.10, “Stopping”</a>
     </p></li><li><p>Stopping MSS for Tomcat: <a class="xref" href="sssicar-SIP_Servlets_Server-Installing_Configuring_and_Running.html#bssswticar-binary-SIP_Servlets_Server_with_Tomcat-Stopping" title="2.2.8. Stopping">Section 2.2.8, “Stopping”</a>
     </p></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="ssfjcs-binary-SIP_Servlets_Server_Cluster-Testing"/>5.1.1.5. Testing</h4></div></div></div><p>To test your JBoss cluster setup for mid-call failover (Established SIP Dialog), refer to:</p><div class="itemizedlist"><ul><li><p>
      <a class="xref" href="ch05.html#ssfjfs-SS_for_JBoss-Failover_Support" title="5.2. Mobicents SIP Servlets for JBoss: Transparent Failover">Section 5.2, “Mobicents SIP Servlets for JBoss: Transparent Failover”</a>
     </p></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="ssfjcs-binary-SIP_Servlets_Server_Cluster-Uninstalling"/>5.1.1.6. Uninstalling</h4></div></div></div><p>Uninstalling a SIP Servlets Cluster would entail deleting the Mobicents SIP Servlets Servers directories, the SIP Load Balancer directory, and possibly removing the unused <code class="envar">JBOSS_HOME</code> environment variable.</p></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="ssfjfs-SS_for_JBoss-Failover_Support"/>5.2. Mobicents SIP Servlets for JBoss: Transparent Failover</h2></div></div></div><p>A Mobicents SIP Servlets Server for JBoss cluster does not employ any standby nodes. 
  Typically, therefore, proxies and registrars must share the user location table by using a database cluster.</p><p>The Mobicents SIP load balancer, which is a SIP Call ID-aware load balancer, is used as the intermediary. 
  The SIP load balancer forwards stateful transaction requests to cluster nodes based on its provisioning algorithm. 
  The SIP load balancer acts as an entry-point to the cluster and distributes the incoming requests between nodes. 
  It is always advised to use a SIP load balancer or an IP load balancer in a cluster configuration. </p><p>The SIP Stack used by the Mobicents SIP Servlets for JBoss supports <code class="literal">ESTABLISHED SIP DIALOG</code> failover. This means that failover will occur only on established calls (SIP Dialogs which are in the CONFIRMED state as per RFC 3261) and calls that are in the process of being setup will not be failed over (SIP Dialogs which are in the EARLY state as per RFC 3261).</p><h5 xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="formalpara">Testing a cluster</h5><p class="formalpara">This choice of implementation has many benefits:</p><div class="itemizedlist"><ul><li><p>There is no need for standby nodes, because the remaining nodes in a degraded cluster automatically and transparently (to the user) take on the load of the failed node. This can be done because both the SIP load balancer and SIP Servlet-enabled JBoss Application Servers support mid-call failover (Established SIP Dialog).</p></li><li><p>There is no need to ensure that requests are directed to the correct node, because in a SIP Servlets-enabled JBoss Application Server (or Mobicents JAIN SLEE server) cluster, any node can serve any request to any User Agent (UA).</p></li><li><p>All hardware is in use, reducing costs.</p></li><li><p>Maintenance is easier, due to all nodes having nearly-identical configurations.</p></li></ul></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="ssfjfs-binary-Testing_SS_for_JBoss_Cluster_Failover--Installing_Configuring_and_Running"/>5.2.1. MSS for JBoss Cluster: Installing, Configuring and Running</h3></div></div></div><p>There are a number of options you can specify for MSS clustering. By default most of them are configured in the "all" server configuration, which is ready to use. In this chapter we will cover the most common configuration options you might need.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="ssfjfs-binary-Testing_SS_for_JBoss_Cluster_Failover-Downloading"/>5.2.1.1. Downloading</h4></div></div></div><p/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="ssfjfs-binary-Testing_SS_for_JBoss_Cluster_Failover-Installing"/>5.2.1.2. Installing</h4></div></div></div><p/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="ssfjfs-binary-Testing_SS_for_JBoss_Cluster_Failover-Configuring"/>5.2.1.3. Configuring</h4></div></div></div><p/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="ssfjfs-binary-Testing_SS_for_JBoss_Cluster_Failover-Running"/>5.2.1.4. Running</h4></div></div></div><p/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="ssfjfs-binary-Testing_SS_for_JBoss_Cluster_Failover-Using"/>5.2.1.5. Using</h4></div></div></div><p/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="ssfjfs-binary-Testing_SS_for_JBoss_Cluster_Failover-Testing"/>5.2.1.6. Testing</h4></div></div></div><p/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="ssfjfs-binary-Testing_SS_for_JBoss_Cluster_Failover-Uninstalling"/>5.2.1.7. Uninstalling</h4></div></div></div><p/></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="sslb-MSS_Load_Balancer"/>5.3. Load Balancer</h2></div></div></div><div class="figure"><a id="d0e5781"/><div class="figure-contents"><div class="mediaobject"><a id="sslb-mss-MSSSIPLoadBalancer-dia-StarNetworkTopology"/><img src="images/mss-MSSSIPLoadBalancer-dia-StarNetworkTopology.jpg" alt="Star Cluster Topology."/></div></div><p class="title"><b>Figure 5.1. Star Cluster Topology.</b></p></div><br class="figure-break"/><p>The Mobicents SIP load balancer is used to balance the load of SIP service requests and responses between nodes in a SIP Servlets Server cluster. Both MSS for JBoss and MSS for Tomcat servers can be used in conjunction with the SIP load balancer to increase the performance and availability of SIP services and applications. </p><p>In terms of functionality, the Mobicents SIP load balancer is a simple stateless proxy server that intelligently forwards SIP session requests and responses between User Agents (UAs) on a Wide Area Network (WAN), and SIP Servlets Server nodes, which are almost always located on a Local Area Network (LAN). All SIP requests and responses pass through the SIP load balancer.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="sslb-SIP_Load_Balancing_Basics"/>5.3.1. SIP Load Balancing Basics</h3></div></div></div><p>All User Agents send SIP messages, such as <code class="literal">INVITE</code> and  <code class="literal">MESSAGE</code>, to the same SIP URI (the IP address and port number of the SIP load balancer on the WAN). The load balancer then parses, alters, and forwards those messages to an available node in the cluster. If the message was sent as a part of an existing SIP session, it will be forwarded to the cluster node which processed that User Agent's original transaction request. </p><p>The SIP Servlets Server that  receives the message  acts upon it and sends a response back to the SIP load balancer. The SIP load balancer reparses, alters and forwards the message back to the original User Agent. This entire proxying and provisioning process is carried out independent of  the User Agent, which is only concerned with the SIP service or application it is using.</p><p>By using the load balancer, SIP traffic is balanced across a pool of available SIP Servlets Servers, increasing the overall throughput of the SIP service or application running on either individual nodes of the cluster.  In the case of   MSS for JBoss's <code class="literal">&lt;/distributed&gt;</code> capabilities, load balancing advantages are applied across the entire cluster.</p><p>The SIP load balancer is also able to fail over requests mid-call from unavailable nodes to available ones, thus increasing the reliability of the SIP service or application.  The load balancer increases throughput and reliability by dynamically provisioning SIP service requests and responses across responsive nodes in a cluster.  This enables SIP applications to meet the real-time demand for SIP services.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e5812"/>5.3.2. HTTP Load Balancing Basics</h3></div></div></div><p>In addition to the SIP load balancing, there are several options for coordinated or cooperative load balancing with other protocols such as HTTP. Typically, a JBoss Application Server will use apache HTTP server with mod_jk, mod_proxy, mod_cluster or similar extension installed as an HTTP load balancer. This apache-based load balancer will parse incoming HTTP requests and it will look for the session ID of those requests in order to ensure all requests from the same session arrive at the same application server. By default, this is done by examining the <code class="literal">jsessionid</code> HTTP cookie or GET parameter and looking for the   <code class="literal">jvmRoute</code> assigned to the session. The typical <code class="literal">jsessionid</code> value is of the form <code class="literal">&lt;sessionId&gt;.&lt;jvmRoute&gt;</code> (e.g. <code class="literal">mysessionid323424.node1</code> where <code class="literal">node1</code> is the <code class="literal">jvmRoute</code> component). The very first request for each new HTTP session do not have any session ID assigned, thus apache routes the request to a random application server node. When the node responds it assigns a session ID and <code class="literal">jvmRoute</code> to the response of the request in a HTTP cookie and this response goes back to the client through apache, which keeps track of which node owns which <code class="literal">jvmRoute</code>. Once, the very first request is served this way, the subsequent requests from this session will carry the assigned cookie and the apache load balancer will always route the requests to the node, which advertised itself as the <code class="literal">jvmRoute</code> owner.</p><p>Instead of using apache,  an  integrated HTTP load balancing is also available. The SIP load balancer has an HTTP port where you could direct all incoming HTTP requests. The integrated HTTP load balancer behaves exactly like apache by default, but this behaviour is extensible and can be overridden completely with the pluggable balancer algorithms. The integrated HTTP load balancer  is much easier to configure and generally requires no effort, because it reuses most SIP settings ans assumes reasonable default values.</p><p>Unlike the native apache, the integrated HTTP load balancer is written completely in Java, thus a performance penalty should be expected when using it. However, the integrated HTTP balancer has an advantage when related SIP and HTTP requests must stick to the same node.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e5851"/>5.3.3. Pluggable balancer algorithms</h3></div></div></div><p>The SIP/HTTP load balancer exposes an interface to allow users to customize the routing decision making for special purposes. By default there are three built-in algorithms. Only one algorithm is active at any time and it is specified with the <code class="literal">algorithmClass</code> property in the configuration file.</p><p>It is completely up to the algorithm how and whether to support distributed architecture or how to store the information needed for session affinity. The algorithms will be called for every SIP and HTTP request and other significant events to make more informed decisions.</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>Users must be aware that, bydefault requests explicitly addressed to a live server node passing through the load balancer will be forwarded directly to the server node. This allows for pre-specified routing use-cases, where the target node is known by the SIP client through other means. If the target node is dead, then the  node selection algorithm is used to route the request to an available node.</p></div>The following is a list o the built-in algorithms:<div class="variablelist"><dl><dt><span class="term">org.mobicents.tools.sip.balancer.CallIDAffinityBalancerAlgorithm </span></dt><dd><p>This algorithm is not distributable. It selects nodes randomly to serve a give Call-ID extracted from the requests and responses. It keeps a map with  <code class="literal">Call-ID -&gt; nodeId</code> associations and this map is not shared with other load balancers which will cause them to make different decisions. For HTTP it behaves like apache.</p></dd><dt><a id="sslb-binary-SIP_Load_Balancer-Configuration_Properties_File_1"/><span class="term">org.mobicents.tools.sip.balancer.HeaderConsistentHashBalancerAlgorithm </span></dt><dd><p>This algorithm is distributable and can be used in distributed load balancer configurations. It extracts the hash value of specific headers from SIP and HTTP messages to decide which application server node will handle the request. Information about the options in this algorithms is available in the balancer configuration file comments.</p></dd><dt><a id="sslb-binary-SIP_Load_Balancer-Configuration_Properties_File_2"/><span class="term">org.mobicents.tools.sip.balancer.PersistentConsistentHashBalancerAlgorithm </span></dt><dd><p>This algorithm is distributable and is similar to the previous algorithm, but it attempts to keep session affinity even when the cluster nodes are removed or added, which would normally cause hash values to point to different nodes.</p></dd></dl></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e5888"/>5.3.4. Distributed load balancing</h3></div></div></div><p>When the capacity of a single load balancer is exceeded, multiple load balancers can be used. With the help of an IP load balancer the traffic can be distributed between all SIP/HTTP load balancers based on some IP rules or round-robin. With consistent hash and <code class="literal">jvmRoute</code>-based balancer algorithms it doesn't matter which SIP/HTTP load balancer will process the request, because they would all make the same decisions based on information in the requests (headers, parameters or cookies) and the list of available nodes. With consistent hash algorithms there is no state to be preserved in the SIP/HTTP balancers.</p><div class="figure"><a id="d0e5896"/><div class="figure-contents"><div class="mediaobject"><a id="sslb-mss-MSSSIPLoadBalancer-dia-StarNetworkTopology_2"/><img src="images/bidirectional-distributed-sip-lb.gif" alt="Example deployment scenario with IP load balancers serving both directions for incoming and outgoing requests in a cluster"/></div></div><p class="title"><b>Figure 5.2. Example deployment scenario with IP load balancers serving both directions for incoming and outgoing requests in a cluster</b></p></div><br class="figure-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="sslb-SIP_Servlets_Load_Balancer-Implementation"/>5.3.5. Implementation of the Mobicents Load Balancer</h3></div></div></div><p>Each individual Mobicents SIP Servlets Server in the cluster is responsible for contacting the SIP load balancer and relaying its health status and regular "heartbeats".  </p><p>From these health status reports and heartbeats, the SIP load balancer creates and maintains a list of all available and healthy nodes in the cluster. The load balancer forwards SIP requests between these cluster nodes,  providing that the provisioning algorithm reports that each node is healthy and is still sending heartbeats. </p><p>If an abnormality is detected, the  SIP load balancer removes the unhealthy or unresponsive node from the  list of available nodes. In addition, mid-session and mid-call messages are failed over to a healthy node. </p><p>For more information about this aspect of the load balancer,  refer to <a class="xref" href="ch05.html#ssfjfs-SS_for_JBoss-Failover_Support" title="5.2. Mobicents SIP Servlets for JBoss: Transparent Failover">Section 5.2, “Mobicents SIP Servlets for JBoss: Transparent Failover”</a>.</p><p>The SIP load balancer first receives SIP requests from endpoints on a port that is specified in its Configuration Properties configuration file. The SIP load balancer, using a round-robin algorithm, then selects a node to which it forwards the SIP requests. The load balancer  forwards all same-session requests to the first node selected to initiate the session, providing that the  node is healthy and available.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e5918"/>5.3.6. SIP Message Flow</h3></div></div></div><p>The Mobicents SIP load balancer appends  itself to the <code class="literal">Via</code> header of each request, so that returned responses are sent to the SIP Balancer before they are sent to the originating endpoint. </p><p>The load balancer also adds itself to the path of subsequent requests by adding Record-Route headers. It can subsequently handle mid-call failover by forwarding  requests to a different node in the cluster if the node that  originally handled the request   fails or becomes unavailable. The SIP load balancer  immediately fails over if it receives and unhealthy status, or irregular  heartbeats from a node.</p><p>The SIP Servlets Server extends the <code class="literal">SipStandardService</code> class, which extends the Tomcat <code class="literal">StandardService</code> class.  The <code class="literal">StandardService</code> class is responsible for  implementing  the Tomcat <code class="literal">Service</code> interface. </p><p>In  Tomcat architecture, a service is an intermediate component which resides inside a server,  and binds  one or more <code class="literal">Connectors</code> to exactly one <code class="literal">Engine</code>. When the service is started, the new <code class="literal">SipStandardBalancerNodeService</code> looks up its configuration information and obtains the SIP load balancer address.  The  heartbeat and health status is sent to the SIP load balancer address  to identify the service  as an available node of the cluster.</p><p>The node parameters are configurable through their <code class="literal">MBean</code> interfaces; information on their configuration is provided in the following sections.</p><p>In advanced configurations, it is possible to run more than one SIP load balancer.</p><p><a class="xref" href="ch05.html#figure-mss-Basic_IP_and_Port_Cluster_Configuration" title="Figure 5.3. Basic IP and Port Cluster Configuration">Figure 5.3, “Basic IP and Port Cluster Configuration”</a> describes a basic  IP and Port Cluster Configuration.  In the diagram, the SIP load balancer is the server with the IP address of <code class="literal">192.168.1.1</code>.</p><div class="figure"><a id="figure-mss-Basic_IP_and_Port_Cluster_Configuration"/><div class="figure-contents"><div class="mediaobject" align="center"><a id="sslb-mss-MSSSIPLoadBalancer-dia-ClusterIPsAndPorts"/><img src="images/mss-MSSSIPLoadBalancer-dia-ClusterIPsAndPorts.jpg" align="middle" alt="Basic IP and Port Cluster Configuration"/></div></div><p class="title"><b>Figure 5.3. Basic IP and Port Cluster Configuration</b></p></div><br class="figure-break"/></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="sslb-binary-SIP_Load_Balancer-Installing_Configuring_and_Running"/>5.3.7. SIP Load Balancer: Installing, Configuring and Running</h3></div></div></div><p/><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="sslb-binary-SIP_Load_Balancer-PreInstall_Requirements_and_Prerequisites"/>5.3.7.1. Pre-Install Requirements and Prerequisites</h4></div></div></div><p/><div class="variablelist"><a id="sslb-binary-SIP_Load_Balancer-Software_Prerequisites"/><p class="title"><b>Software Prerequisites</b></p><dl><dt><span class="term">A SIP Servlet-Enabled JBoss Application Server or Tomcat Servlet Container</span></dt><dd><p>Running the SIP load balancer requires at least two SIP Servlets Servers as client nodes.  Therefore, before configuring the SIP load balancer, we should make sure we've installed a SIP Servlets Server first. The Mobicents SIP load balancer will work with a SIP Servlets-enabled JBoss Application Server <span class="emphasis"><em>or</em></span> a SIP Servlets-enabled Tomcat Container.</p><p>However, if you intend to cluster multiple nodes for performance, reliability and failover purposes, then you will want to install and set up SIP Servlets-enabled JBoss AS nodes, because only they can be clustered, and not SIP-Servlet Tomcat Containers.</p><div class="itemizedlist"><ul><li><p>To install a SIP Servlet-enabled JBoss Application Server, follow the instructions here: <a class="xref" href="sssicar-SIP_Servlets_Server-Installing_Configuring_and_Running.html#bssswjicar-binary-SIP_Servlets_Server_with_JBoss-Installing_Configuring_and_Running" title="2.1. SIP Servlet-Enabled JBoss Application Server: Installing, Configuring and Running">Section 2.1, “SIP Servlet-Enabled JBoss Application Server: Installing, Configuring and Running”</a>.</p></li><li><p>To install a SIP Servlet-enabled Tomcat Servlet Container, follow these instructions: <a class="xref" href="sssicar-SIP_Servlets_Server-Installing_Configuring_and_Running.html#bssswticar-SIP_Servlets_Server_with_Tomcat-Installing_Configuring_and_Running" title="2.2. SIP Servlet-Enabled Tomcat Servlet Container: Installing, Configuring and Running">Section 2.2, “SIP Servlet-Enabled Tomcat Servlet Container: Installing, Configuring and Running”</a>.</p></li></ul></div></dd></dl></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="sslb-binary-SIP_Load_Balancer-Downloading"/>5.3.7.2. Downloading</h4></div></div></div><p>The load balancer is located in the <code class="filename">sip-balancer</code> top-level directory of the MSS distribution. You will find the following files in the directory:</p><div class="variablelist"><dl><dt><span class="term">SIP load balancer executable JAR file</span></dt><dd><p>This is the binary file with all dependencies</p></dd><dt><a id="sslb-binary-SIP_Load_Balancer-Configuration_Properties_File"/><span class="term">SIP load balancer Configuration Properties file</span></dt><dd><p>This is the properties files with various settings</p></dd></dl></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="sslb-binary-SIP_Load_Balancer-Installing"/>5.3.7.3. Installing</h4></div></div></div><p>The SIP load balancer executable JAR file can be placed anywhere in the file system.  It is recommended that the file is placed in the directory containing other JAR executables, so it can be easily located in the future.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="sslb-binary-SIP_Load_Balancer-Configuring"/>5.3.7.4. Configuring</h4></div><div><h4 class="title"><a id="sslb-binary-SIP_Load_Balancer-Configuring"/>5.3.7.4. Configuring</h4></div></div></div><p>Configuring the SIP load balancer and the two SIP Servlets-enabled Server nodes is described in <a class="xref" href="ch05.html#sslb-Configuring_the_SIP_Load_Balancer_and_Servlet_Server_Nodes" title="Procedure 5.1. Configuring the Mobicents SIP Load Balancer and Servlet Server Nodes">Configuring the Mobicents SIP Load Balancer and Servlet Server Nodes</a>.</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="procedure"><a id="sslb-Configuring_the_SIP_Load_Balancer_and_Servlet_Server_Nodes"/><p class="title"><b>Procedure 5.1. Configuring the Mobicents SIP Load Balancer and Servlet Server Nodes</b></p><ol class="1"><li><p class="title"><b>Configure lb.properties Configuration Properties File</b></p><p>Configure the SIP load balancer's Configuration Properties file by substituting valid values for your personal setup.  <a class="xref" href="ch05.html#sslb-Complete_Sample_lb.properties_File" title="Example 5.1. Complete Sample lb.properties File">Example 5.1, “Complete Sample lb.properties File”</a>  shows a sample <code class="filename">lb.properties</code> file, with key element descriptions provided after the example. The lines beginning with the pound sign are comments.</p><div class="example"><a id="sslb-Complete_Sample_lb.properties_File"/><p class="title"><b>Example 5.1. Complete Sample lb.properties File</b></p><div class="example-contents"><pre class="programlisting">
# Mobicents Load Balancer Settings
# For an overview of the Mobicents Load Balancer visit http://docs.google.com/present/view?id=dc5jp5vx_89cxdvtxcm

# The binding address of the load balancer
host=127.0.0.1

# The RMI port used for heartbeat signals
rmiRegistryPort=2000

# The SIP port used where client should connect
externalPort=5060
 
# The SIP port from where servers will receive messages
# delete if you want to use only one port for both inbound and outbound)
# if you like to activate the integrated HTTP load balancer, this is the entry point
internalPort=5065
 
# The HTTP port for HTTP forwarding
httpPort=2080

#Specify UDP or TCP (for now both must be the same)
internalTransport=UDP
externalTransport=UDP

# If you are using IP load balancer, put the IP address and port here
#externalIpLoadBalancerAddress=127.0.0.1
#externalIpLoadBalancerPort=111
 
# Requests initited from the App Servers can route to this address (if you are using 2 IP load balancers for bidirectional SIP LB)
#internalIpLoadBalancerAddress=127.0.0.1
#internalIpLoadBalancerPort=111

# Designate extra IP addresses as serer nodes
#extraServerNodes=222.221.21.12:21,45.6.6.7:9003,33.5.6.7,33.9.9.2

# Call-ID affinity algortihm settings. This algorithm is the default. No need to uncomment it.
#algorithmClass=org.mobicents.tools.sip.balancer.CallIDAffinityBalancerAlgorithm
# This property specifies how much time to keep an association before being evitcted.
# It is needed to avoid memory leaks on dead calls. The time is in seconds.
#callIdAffinityMaxTimeInCache=500

# Uncomment to enable the consistent hash based on Call-ID algorithm.
#algorithmClass=org.mobicents.tools.sip.balancer.HeaderConsistentHashBalancerAlgorithm
# This property is not required, it defaults to Call-ID if not set, cna be "from.user" or "to.user" when you want the SIP URI username
#sipHeaderAffinityKey=Call-ID
#specify the GET HTTP parameter to be used as hash key
#httpAffinityKey=appsession
 
# Uncomment to enable the persistent consistent hash based on Call-ID algorithm.
#algorithmClass=org.mobicents.tools.sip.balancer.PersistentConsistentHashBalancerAlgorithm
# This property is not required, it defaults to Call-ID if not set
#sipHeaderAffinityKey=Call-ID
#specify the GET HTTP parameter to be used as hash key
#httpAffinityKey=appsession
 
#This is the JBoss Cache 3.1 configuration file (with jgroups), if not specified it will use default
#persistentConsistentHashCacheConfiguration=/home/config.xml
 
# Call-ID affinity algortihm settings. This algorithm is the default. No need to uncomment it.
#algorithmClass=org.mobicents.tools.sip.balancer.CallIDAffinityBalancerAlgorithm
# This property specifies how much time to keep an association before being evitcted.
# It is needed to avoid memory leaks on dead calls. The time is in seconds.
#callIdAffinityMaxTimeInCache=500

# Uncomment to enable the consistent hash based on Call-ID algorithm.
#algorithmClass=org.mobicents.tools.sip.balancer.HeaderConsistentHashBalancerAlgorithm
# This property is not required, it defaults to Call-ID if not set, cna be "from.user" or "to.user" when you want the SIP URI username
#sipHeaderAffinityKey=Call-ID
#specify the GET HTTP parameter to be used as hash key
#httpAffinityKey=appsession

# Uncomment to enable the persistent consistent hash based on Call-ID algorithm.
#algorithmClass=org.mobicents.tools.sip.balancer.PersistentConsistentHashBalancerAlgorithm
# This property is not required, it defaults to Call-ID if not set
#sipHeaderAffinityKey=Call-ID
#specify the GET HTTP parameter to be used as hash key
#httpAffinityKey=appsession
 
#This is the JBoss Cache 3.1 configuration file (with jgroups), if not specified it will use default
#persistentConsistentHashCacheConfiguration=/home/config.xml

#Adjusting the heatbeat. The hearbeat must be specified together with the individual server JAIN SIP property org.mobicents.ha.javax.sip.HEARTBEAT_INTERVAL
#If a node doesnt check in within that time (in ms), it is considered dead
nodeTimeout=5100
#The consistency of the above condition is checked every heartbeatInterval milliseconds
heartbeatInterval=150


#JSIP stack configuration.....
javax.sip.STACK_NAME = SipBalancerForwarder
javax.sip.AUTOMATIC_DIALOG_SUPPORT = off
// You need 16 for logging traces. 32 for debug + traces.
// Your code will limp at 32 but it is best for debugging.
gov.nist.javax.sip.TRACE_LEVEL = 32
gov.nist.javax.sip.DEBUG_LOG = logs/sipbalancerforwarderdebug.txt
gov.nist.javax.sip.SERVER_LOG = logs/sipbalancerforwarder.xml
gov.nist.javax.sip.THREAD_POOL_SIZE = 64
gov.nist.javax.sip.REENTRANT_LISTENER = true

            </pre></div></div><br class="example-break"/><div class="variablelist"><dl><dt><span class="term">host</span></dt><dd><p>Local IP address, or interface, on which the SIP load balancer will listen for incoming requests.</p></dd><dt><span class="term">externalPort</span></dt><dd><p>Port on which the SIP load balancer listens for incoming requests from SIP User Agents.</p></dd><dt><span class="term">internalPort</span></dt><dd><p>Port on which the SIP load balancer forwards incoming requests to available, and healthy, SIP Servlets Server cluster nodes.</p></dd><dt><span class="term">rmiRegistryPort</span></dt><dd><p>Port on which the SIP load balancer will establish the RMI heartbeat connection to the application servers. When this connection fails or a disconnection instruction is received, an application server node is removed and handling of requests continues without it by redirecting the load to the lie nodes.</p></dd><dt><span class="term">httpPort</span></dt><dd><p>Port on which the SIP load balancer will accept HTTP requests to be distributed across the nodes.</p></dd><dt><span class="term"> internalTransport</span></dt><dd><p>Transport protocol for the internal SIP connections associated with the internal SIP port of the load balancer. Possible choices are <code class="literal">UDP</code>, <code class="literal">TCP</code> and <code class="literal">TLS</code>.</p></dd><dt><span class="term"> externalTransport</span></dt><dd><p>Transport protocol for the external SIP connections associated with the external SIP port of the load balancer. Possible choices are <code class="literal">UDP</code>, <code class="literal">TCP</code> and <code class="literal">TLS</code>. It must match the transport of the internal port.</p></dd><dt><span class="term">externalIpLoadBalancerAddress</span></dt><dd><p>Address of the IP load balancer (if any) used for incoming requests to be distributed in the direction of the application server nodes. This address may be used by the SIP load balancer to be put in SIP headers where the external address of the SIP load balancer is needed.</p></dd><dt><span class="term">externalIpLoadBalancerPort</span></dt><dd><p>The port of the external IP load balancer. Any messages arriving at this port should be distributed across the external SIP ports of a set of   SIP load balancers.</p></dd><dt><span class="term">internalIpLoadBalancerAddresst</span></dt><dd><p>Address of the IP load balancer (if any) used for outgoing requests (requests initiated from the servers) to be distributed in the direction of the clients. This address may be used by the SIP load balancer to be put in SIP headers where the internal address of the SIP load balancer is needed.</p></dd><dt><span class="term">internalIpLoadBalancerPort</span></dt><dd><p>The port of the internal IP load balancer. Any messages arriving at this port should be distributed across the internal SIP ports of a set of   SIP load balancers.</p></dd><dt><span class="term">extraServerNodes</span></dt><dd><p>Comma-separated list of hosts that are server nodes. You can put here alternative names of the application servers here and they will be recognized. Names are important, because they might be used for direction-analysis. Requests coming from these server will go in the direction of the clients and will not be routed back to the cluster.</p></dd><dt><span class="term">algorithmClass</span></dt><dd><p>The fully-qualified Java class name of the balancing algorithm to be used. There are three algorithms to choose from and you can write your own to implement more complex routing behaviour. Refer to the sample configuration file for details about the available options for each algorithm. Each algorithm can have algorithm-specific properties for fine-grained configuration.</p></dd><dt><span class="term">nodeTimeout</span></dt><dd><p>In milliseonds. Default value is 5100. If a server node doesnt check in within this time (in ms), it is considered dead.</p></dd><dt><span class="term">heartbeatInterval</span></dt><dd><p>In milliseconds. Default value is 150 milliseonds. The hearbeat interval  must be much smaller than the interval specified  in the   JAIN SIP property on the server machines - <code class="literal">org.mobicents.ha.javax.sip.HEARTBEAT_INTERVAL</code></p></dd></dl></div><div class="note"><h2>Note</h2><p>The remaining keys and properties in the configuration properties file can be used to tune the JAIN SIP stack, but are not specifically required for load balancing.  To assist with tuning, a comprehensive list of implementing classes for the SIP Stack is available from the <a class="ulink" href="http://snad.ncsl.nist.gov/proj/iptel/jain-sip-1.2/javadoc/javax/sip/SipStack.html">Interface SIP Stack page on nist.gov</a>.  For a comprehensive list of properties associated with the SIP Stack implementation, refer to <a class="ulink" href="http://snad.ncsl.nist.gov/proj/iptel/jain-sip-1.2/javadoc/gov/nist/javax/sip/SipStackImpl.html">Class SipStackImpl page on nist.gov</a>.</p></div></li><li><p class="title"><b>Configure the <code class="filename">server.xml</code> configuration file</b></p><p>Ensure the following attributes are configured for the <code class="literal">&lt;service&gt;</code> element in <code class="filename">server.xml</code>.</p><div class="itemizedlist"><ul><li><p>The <code class="literal">className</code> attribute must have the value <code class="literal">org.mobicents.servlet.sip.startup.failover.SipStandardBalancerNodeService</code> instead of <code class="literal">org.mobicents.servlet.sip.startup.SipStandardService.</code></p></li><li><p>The <code class="literal">balancers</code> attribute must contain a IP address (or list of addresses) of the SIP load balancer(s) to which heartbeat information will be sent.</p></li><li><p>The <code class="literal">sipPathName</code> attribute must contain the following value <code class="literal">org.mobicents.ha</code> to indicate that the server will be using the Mobicents JAIN SIP HA SIP Stack which is an extension of the JAIN SIP Stack offering transparent replication.</p></li></ul></div></li></ol></div><p>the SIP load balancer uses <a class="ulink" href="http://java.sun.com/j2se/1.4.2/docs/guide/util/logging/overview.html">Java Logging as a logging mechanism</a>. As such you cna configure it through a property file and specify the property file to be used by using the following command <code class="literal">-Djava.util.logging.config.file=./lb-logging.properties</code>. Please refer to JDK logging for more informationon how to configure the Java logging.</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Configuration File Locations</h2><p>On MSS for Tomcat server installations, <code class="filename">server.xml</code> is located in <code class="filename">&lt;install_directory&gt;/conf</code>.</p><p>On MSS for JBoss server installations, the default <code class="filename">server.xml</code> configuration file is located
         in <code class="filename">server/default/deploy/jboss-web.sar</code> (or <code class="filename">server/default/deploy/jboss-web.deployer</code> for JBoss Application Server 4.x and EAP 4.x).</p><p>On MSS for JBoss installations, with JBoss clustering support enabled, the "all" <code class="filename">server.xml</code> file must be configured.  It is located in <code class="filename">server/all/deploy/jboss-web.deployer</code>.</p><p>To determine what profile should be altered for each MSS for JBoss installation, refer to <a class="xref" href="ch05.html#ssfjcs-SS_for_JBoss-Clustering_Support" title="5.1. Mobicents SIP Servlets for JBoss: Clustering Support">Section 5.1, “Mobicents SIP Servlets for JBoss: Clustering Support”</a>.</p></div><h5 xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="formalpara">Easy Node Configuration with JMX</h5><p class="formalpara">Both SIP Servlet-enabled JBoss and Tomcat have <acronym class="acronym">JMX</acronym> (Java Management Extensions) interfaces that allow for easy server configuration. The JMX Console is available once the server has been started by navigating to <a class="ulink" href="http://localhost:8080/jmx-console/">http://localhost:8080/jmx-console/</a>.  </p><p>Both the <code class="literal">balancers</code> and <code class="literal">heartBeatInterval</code> attribute values are available under <code class="literal">serviceName=jboss.web,type=Service</code> in the JMX Console.</p><div class="variablelist"><dl><dt><span class="term">balancers</span></dt><dd><p>Host names of the SIP load balancer(s) with corresponding <code class="literal">addBalancerAddress</code> and <code class="literal">removeBalancerAddress</code> methods.</p></dd><dt><span class="term">heartBeatInterval</span></dt><dd><p>Interval at which each heartbeat is sent to the SIP load balancer(s).</p></dd></dl></div><p> </p><div class="section" lang="en-US"><div class="titlepage"><div><div><h5 class="title"><a id="d0e6307"/>5.3.7.4.1. Converged Load Balancing</h5></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h6 class="title"><a id="d0e6310"/>5.3.7.4.1.1. Apache HTTP load balancer</h6></div></div></div><p>The MSS SIP load balancer can work in concert  with HTTP load balancers such as  <code class="literal">mod_jk</code> and <code class="literal">mod_proxy</code> in two different ways. 
          By default whenever an HTTP session is bound to a particular node, an instruction is sent to the SIP load balancer to direct the SIP calls from the same application 
          session to the same node.</p><p>It is sufficient to configure <code class="literal">mod_jk</code> to work for HTTP in JBoss in order to enable cooperative load balancing. MSS will read the
           configuration and will use it without any extra configuration. You can read more about configuring <code class="literal">mod_jk</code> with JBoss in your JBoss Application Server 
           documentation.</p><p>Alternatively you may disable this behaviour and make the HTTP load balancer follow the decisions made by the SIP load balancer with the httpFollowsSip flag. This is 
          achieved by changing the jvmRoute part of the session ID cookie used internally by <code class="literal">mod_jk</code>.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h6 class="title"><a id="d0e6334"/>5.3.7.4.1.1.1. The httpFollowsSip flag</h6></div></div></div><p>The <code class="literal">httpFollowsSip</code> flag in the service configuration makes the application server aware of how different mod_jk and SIP load balancers have assigned 
          request affinity for each application session. The application servers assign exactly one node to each Sip Servlets application session and this node is the node where the
           last SIP request associated with the application session has landed (decised by the SIP load balancer). Then the application server will actively update the session ID
            cookie (the jvmRoute part) of any HTTP request that arrives at 
          the wrong node. The application server will do so with a specially composed HTTP redirect response or with a HTML refresh hint. As a backup strategy, if the request is bound to seek
           non-existing node forever and it will let the request be served by a new node. This avoids having a client stuck reloading the same page over and over.</p><p>One problem with this flag is that if you have two or more SIP sessions associated with the same application session and the load balancer has decided to send SIP requests
           to different nodes, which might happend if you use Call-ID based affinity, then the application server will have to change the jvmRoute very often for every SIP request resulting
            in significant overhead. It is generally not adviced to enable this flag if you have more than 1 SIP session per application session and the means to guarantee all SIP sessions
            from the application session will land on the same node.</p><p>This is an example how to enable the option. It is disabled by default.</p><pre class="programlisting">&lt;Connector port="5080" 
     ipAddress = "${jboss.bind.address}"
     ...
     httpFollowsSip="true" /&gt;
</pre></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h6 class="title"><a id="d0e6348"/>5.3.7.4.1.2. Integrated HTTP load balancer</h6></div></div></div><p>To use the integrated HTTP load balancer, no extra configuration is needed. If a unique  <code class="literal">jvmRoute</code> is specified and enabled  in each application server, it will behave exactly as the apache balancer. If <code class="literal">jvmRoute</code> is not present it will use session ID as a hash value and attempt to create sticky session. The integrated balancer can be used together with the apache balancer at the same time.</p><p>In addition to the apache behaviour, there is a consistent hash balancer algorithm that can be enabled for both HTTP and SIP messages. For both HTTP and SIP messages, there is a configurable affinity key, which is evaluated and hashed against each unassigned request. All requests with the same hash value will always be routed to the same application server node. For example, the SIP affinity key could be the callee user name and the HTTP affinity key could the “<span class="quote">appsession</span>” HTTP GET parameter of the request. If the desired behaviour group these requests, we can just make sure the affinity values (user name and GET parameter) are the same.</p><div class="figure"><a id="d0e6364"/><div class="figure-contents"><div class="mediaobject"><a id="sslb-mss-MSSSIPLoadBalancer-dia-StarNetworkTopology_1"/><img src="images/converged-integrated-lb.png" alt="Ensuring SIP and HTTP requests are being grouped by common affinity value."/></div></div><p class="title"><b>Figure 5.4. Ensuring SIP and HTTP requests are being grouped by common affinity value.</b></p></div><br class="figure-break"/></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="sslb-binary-SIP_Load_Balancer-Running"/>5.3.7.5. Running</h4></div></div></div><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="procedure"><a id="sslb-Running_the_SIP_Load_Balancer_and_Servlet_Server_Nodes"/><p class="title"><b>Procedure 5.2. Running the SIP Load Balancer and Servlet Server Nodes</b></p><ol class="1"><li><p class="title"><b>Start the SIP Load Balancer</b></p><p>Start the SIP load balancer, ensuring the Configuration Properties file (<code class="filename">lb.properties</code> in this example) is specified.  In the Linux terminal, or using the Windows Command Prompt, the SIP Load Balancer is started by issuing a command similar to this one:</p><pre class="screen">java -jar sip-balancer-1.0-20080829.103906-21-jar-with-dependencies.jar lb-configuration.properties</pre><p>Executing the SIP load balancer produces  output similar to the following example:</p><pre class="screen">home]$ java -jar sip-balancer-1.0-20080829.103906-21-jar-with-dependencies.jar lb-configuration.properties 
Oct 21, 2008 1:10:58 AM org.mobicents.tools.sip.balancer.SIPBalancerForwarder start
INFO: Sip Balancer started on address 127.0.0.1, external port : 5060, port : 5065
Oct 21, 2008 1:10:59 AM org.mobicents.tools.sip.balancer.NodeRegisterImpl startServer
INFO: Node registry starting...
Oct 21, 2008 1:10:59 AM org.mobicents.tools.sip.balancer.NodeRegisterImpl startServer
INFO: Node expiration task created
Oct 21, 2008 1:10:59 AM org.mobicents.tools.sip.balancer.NodeRegisterImpl startServer
INFO: Node registry started</pre><p>The output shows the IP address on which the SIP load balancer is listening, as well as the external and internal listener ports.</p></li><li><p class="title"><b>Configure SIP Servlet Server Nodes</b></p><p>SIP Servlets Server nodes can run on the JBoss Application Server, or the Tomcat Servlet Container.  The SIP Servlets Server binary distributions define the type of SIP Servlets Server nodes used, and should already be installed from <a class="xref" href="ch05.html#sslb-binary-SIP_Load_Balancer-Software_Prerequisites" title="Software Prerequisites">Software Prerequisites</a>.</p><p>The <code class="filename">server.xml</code> file specifies the nodes used.  Because there is more then one client node specified, unique listener ports must be specified for each node to monitor HTTP and/or SIP connections.  <a class="xref" href="ch05.html#sslb-Changing_the_SIP_Connector_Port_for_Servlet_Server_Nodes" title="Example 5.2. Changing the SIP Connector Port for Servlet Server Nodes in server.xml">Example 5.2, “Changing the SIP Connector Port for Servlet Server Nodes in server.xml”</a> describes the affected element in the <code class="filename">server.xml</code> file.</p><div class="note"><h2>Configuration File Location</h2><p>For the JBoss SIP Servlets Server binary distribution, <code class="filename">server.xml</code> is located in the  <code class="filename">&lt;install_directory&gt;/server/all/deploy/jboss-web.deployer/</code> directory (for JBoss Application Server 4.x or EAP 4.x <code class="filename">&lt;install_directory&gt;/server/all/deploy/jboss-web.deployer/</code>).  For the Tomcat binary distribution, <code class="filename">server.xml</code> is located in the <code class="filename">&lt;install_directory&gt;/conf/</code> directory.</p></div><div class="example"><a id="sslb-Changing_the_SIP_Connector_Port_for_Servlet_Server_Nodes"/><p class="title"><b>Example 5.2. Changing the SIP Connector Port for Servlet Server Nodes in server.xml</b></p><div class="example-contents"><pre xmlns="" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_plain"></span><br />
<span class="xml_comment">&lt;!--&nbsp;Define&nbsp;a&nbsp;SIP&nbsp;Connector&nbsp;--&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">Connector</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">port</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;5080&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br />
</pre></div></div><br class="example-break"/></li><li><p class="title"><b>Start Load Balancer Client Nodes</b></p><p>Start all SIP load balancer client nodes.</p></li></ol></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="sslb-binary-SIP_Load_Balancer-Testing"/>5.3.7.6. Testing</h4></div></div></div><p>To test load balancing, the same application must be deployed manually on each node.  Two SIP Softphones must be installed.</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="procedure"><a id="d0e6446"/><p class="title"><b>Procedure 5.3. Testing Load Balancing</b></p><ol class="1"><li><p class="title"><b>Deploy an Application</b></p><p>Ensure that for each node, the DAR file location is specified in the <code class="filename">server.xml</code> file.</p><p>Deploy the Location service manually on both nodes.</p></li><li><p class="title"><b>Start the "Sender" SIP softphone</b></p><p>Start a SIP softphone client with the SIP address of <strong class="userinput"><code>sip:sender@sip-servlets-com</code></strong>, listening on port 5055.  The outbound proxy must be specified as the sip-balancer (http://127.0.0.1:5060)</p></li><li><p class="title"><b>Start the "Receiver" SIP softphone</b></p><p>Start a SIP softphone client with the SIP address of <strong class="userinput"><code>sip:receiver-failover@sip-servlets-com</code></strong>, listening on port 5090.</p></li><li><p class="title"><b>Initiate two calls from "Sender" SIP softphone</b></p><p>Initiate one call from <strong class="userinput"><code>sip:sender@sip-servlets-com</code></strong> to <strong class="userinput"><code>sip:receiver-failover@sip-servlets-com</code></strong>.  Tear down the call once completed.</p><p>Initiate a second call using the same SIP address, and tear down the call once completed.  Notice that the call is handled by the second node.</p></li></ol></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="sslb-binary-SIP_Load_Balancer-Stopping"/>5.3.7.7. Stopping</h4></div></div></div><p>Assuming that you started the JBoss Application Server as a foreground process in the Linux terminal, the easiest way to stop it is by pressing the <span class="keycap"><strong>Ctrl</strong></span>+<span class="keycap"><strong>C</strong></span> key combination in the same terminal in which you started it.</p><p>This should produce similar output to the following:</p><pre class="screen">^COct 21, 2008 1:11:57 AM org.mobicents.tools.sip.balancer.SipBalancerShutdownHook run
INFO: Stopping the sip forwarder</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="sslb-binary-SIP_Load_Balancer-Uninstalling"/>5.3.7.8. Uninstalling</h4></div></div></div><p>To uninstall the SIP load balancer,  delete the JAR file you installed.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e6508"/>5.3.8. IP Load Balancing</h3></div></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e6511"/>5.3.8.1. IP Load Balancers</h4></div></div></div><p>An IP load-balancer is a network appliance that distributes traffic to an application server (or actual servers) using a  load-balancing algorithm.  IP load-balancing is often used when the other load-balancers' capacity is exceeded and can not scale further without hardware upgrades.</p><p>Routing decisions are made  based on OSI Layer 2, 3 or 4 data. This type of load balancer only examines low-level TCP, UDP or ethernet packet structures including MAC addresses, IP addresses, ports, and protocol types (TCP or UDP or other). </p><p>An IP  load balancer never reads the payload of the TCP/IP packets and therefore never parses SIP or HTTP (or any protocol above OSI Layer 4).  Because an IP load balancing device is not SIP or HTTP aware in any way, it is much more performant than <code class="literal">mod_jk</code> or the MSS SIP load-balancer.

</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e6523"/>5.3.8.2. Technical overview</h4></div></div></div><p>In its simplest form, the IP load-balancer usually "owns" the public-facing IP address (known as a VIP).   The traffic is routed to actual servers in it's private network similar to NAT. It is also possible to not change the IP address and just work on the MAC address by assuming that all actual  servers are configured to accept packets for the VIP address. The features offered by the IP load balancer depend largely on the vendor. </p><p>Some examples of  Linux-based  software load balancers include <a class="ulink" href="http://www.redhat.com/cluster_suite/">Red Hat Cluster Suite (RHCS)</a> and <a class="ulink" href="http://www.linuxvirtualserver.org/">Linux Virtual Server (LVS)</a>. There are many hardware vendors as well.</p><p>One main drawback relating to  IP load balancers is that they can not make routing decisions based on SIP messages and (with some exceptions) they can not work cooperatively with HTTP or other load balancers.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e6540"/>5.3.8.3. Configuring MSS Cluster for pure IP Load Balancing</h4></div></div></div><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="warning"><h2>Warning</h2><p>Pure IP load balancing is not a recommented option. It is advised to use a distributed load balancer instead. Proper operation with pure IP load balancing depends on the ability of the IP load balancer to establish request affinity based on IP addresses and ports.</p></div></div><div class="section" lang="en-US"><div class="titlepage"/><p>First you need to remove the SIP load balancers from any configuration in MSS. In particular the <code class="literal">balancers</code> 
      attribute in <code class="filename">server.xml</code>.   and edit the jboss.web  engine tag. You should remove the balancers attribute from the Service tag of 
      jboss.web service. This simply removes the default load balancer from the system and the traffic bypasses the SIP load-balancer. Next you must configure
       MSS to put the IP load balancer IP address in the <code class="literal">Via</code>, <code class="literal">Contact</code> and other system headers where 
       the IP address of the server machine is required. This will ensure that any responses or subsequent SIP requests follow the same path, but always hit 
       the load balancer instead of particular cluster node that may fail.  To specify the IP load balancer address in MSS your should edit
        this file <code class="filename">JBOSS_HOME/server/all/deploy/jboss-web.deployer/server.xml</code> and specify <code class="literal">staticServerAddress</code> such as: </p><pre class="programlisting">&lt;Connector port="5080" 
     ipAddress = "${jboss.bind.address}"
     ...
staticServerAddress="122.122.122.122" staticServerPort="44" 
useStaticAddress="true"/&gt;
</pre><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>Depending on your reliability requirements you can omit the configuration described in this section and let the servers use their own IP address in the SIP messages.</p></div></div></div></div></div><ul class="docnav"><li class="previous"><a accesskey="p" href="ssea-SIP_Servlet_Example_Applications.html"><strong>Prev</strong>Chapter 4. SIP Servlet Example Applications</a></li><li class="up"><a accesskey="u" href="#"><strong>Top of page</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Front page</strong></a></li><li class="next"><a accesskey="n" href="emom-Enterprise-Monitoring-Operations-Management.html"><strong>Next</strong>Chapter 6. Enterprise Monitoring and Management</a></li></ul></body></html>